FROM ubuntu:22.04

# Install dependencies
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    curl \
    git \
    build-essential \
    cmake \
    ninja-build \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Create model directory
RUN mkdir -p /app/model

# Download GGUF model from Hugging Face
RUN echo "ðŸ“¥ Downloading GGUF model from Hugging Face..."
RUN curl -L -o /app/model/qwen-career.gguf "https://huggingface.co/Amritansh8/qwen-career-optimized-cloned/resolve/main/qwen-career-q4_k_m-004.gguf"
RUN echo "âœ… GGUF model downloaded successfully"

# Install Python dependencies
RUN pip3 install --no-cache-dir \
    llama-cpp-python \
    fastapi \
    uvicorn \
    transformers \
    torch

# Copy Python server code
COPY server.py /app/server.py

# Make the server executable
RUN chmod +x /app/server.py

# Expose port
EXPOSE 11434

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=3 \
    CMD curl -f http://localhost:11434/ || exit 1

# Start the server
CMD ["python3", "/app/server.py"]